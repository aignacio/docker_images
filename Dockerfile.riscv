# ---- Build stage ----
# This stage builds all components (toolchain, spike, pk, verilator)

FROM ubuntu:24.04 AS builder

# Set arguments with default versions
# ARG RISCV_TOOLCHAIN_BRANCH=2025.07.16
ARG RV_REPO="riscv-collab/riscv-gnu-toolchain"
ARG RV_TOOLCHAIN_VERSION="riscv64-elf-ubuntu-24.04-gcc-nightly"
ARG VERILATOR_VERSION=stable
ARG SPIKE_VERSION=master

# Install dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    autoconf automake autotools-dev curl jq wget python3 python3-pip libmpc-dev libmpfr-dev libgmp-dev \
    gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev git \
    libexpat-dev libboost-all-dev libyaml-dev device-tree-compiler cmake ninja-build \
    libgoogle-perftools-dev libglib2.0-dev libpixman-1-dev pkg-config python3-setuptools \
    python3-pybind11 && \
    rm -rf /var/lib/apt/lists/*

# Environment
ENV RISCV=/opt/riscv
RUN curl -fsSL https://api.github.com/repos/${RV_REPO}/releases | \
    jq -r --arg pre "${RV_TOOLCHAIN_VERSION}" '.[].assets[] | \
    select(.name|startswith($pre) and endswith(".tar.xz")) | .browser_download_url' | head -n1 | xargs -r curl -fLO
RUN set -eux; \
    FILE="$(ls -1t riscv*-nightly*.tar.xz | head -1)"; \
    mkdir -p "$RISCV"; \
    tar -xJf "$FILE" -C "$RISCV" --strip-components=1; \
    rm -f "$FILE"
#RUN FILE=$(ls -1t riscv*-nightly*.tar.xz | head -1); \
#    mkdir -p "$RISCV"; \
#    TOP=$(tar -tf "$FILE" | head -1 | cut -d/ -f1); \
#    tar -xJf "$FILE" -C "$RISCV"; \
#    ln -sfn "$RISCV/$TOP" "$RISCV/riscv"

# Build RISC-V toolchain (multilib)
#RUN git clone https://github.com/riscv/riscv-gnu-toolchain && \
#    cd riscv-gnu-toolchain && \
#    git checkout ${RISCV_TOOLCHAIN_BRANCH} && \
#    ./configure --prefix=$RISCV --enable-multilib && \
#    make -j$(nproc)

# Build spike
RUN git clone https://github.com/riscv-software-src/riscv-isa-sim.git && \
    cd riscv-isa-sim && \
    git checkout ${SPIKE_VERSION} && \
    mkdir build && cd build && \
    ../configure --prefix=$RISCV && make -j$(nproc) && make install

# # Build proxy kernel (pk)
# RUN git clone https://github.com/riscv-software-src/riscv-pk.git && \
#     cd riscv-pk && \
#     mkdir build && cd build && \
#     ../configure --prefix=$RISCV --host=riscv64-unknown-elf && \
#     make -j$(nproc) && make install

# Build Verilator
RUN apt-get update -y && apt-get install git help2man perl python3 make \
    g++ libfl-dev zlib1g zlib1g-dev ccache mold libgoogle-perftools-dev numactl -y
RUN git clone https://github.com/verilator/verilator && \
    cd verilator && \
    git checkout ${VERILATOR_VERSION} && \
    autoconf && ./configure && make -j$(nproc) && make install

# ---- Final image ----
FROM ubuntu:24.04 AS final

ARG VERILATOR_VERSION=stable

# Copy from build stage
COPY --from=builder /opt/riscv /opt/riscv
COPY --from=builder /usr/local/bin/verilator* /usr/local/bin/
COPY --from=builder /usr/local/share/verilator /usr/local/share/verilator
COPY --from=builder /usr/local/lib /usr/local/lib
COPY --from=builder /usr/local/include /usr/local/include

# Install runtime dependencies
RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    python3 python3-pip curl libboost-all-dev \
    git device-tree-compiler build-essential mold ccache cmake ninja-build \
    libgoogle-perftools-dev libglib2.0-dev libpixman-1-dev && \
    rm -rf /var/lib/apt/lists/* && \
    pip3 install nox --break-system-packages

# Set environment
ENV RISCV=/opt/riscv
ENV PATH=$RISCV/bin:$PATH
ENV VERILATOR_ROOT=/usr/local/share/verilator

# ---------- BASH COLORING --------
# Add color support to bash
RUN echo 'export PS1="\[\033[01;32m\]\u@riscv\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /root/.bashrc
RUN echo 'export PS1="\[\033[01;32m\]\u@riscv\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ "' >> /etc/skel/.bashrc

# Enable color for ls and grep
RUN echo 'alias ls="ls --color=auto"' >> /root/.bashrc
RUN echo 'alias grep="grep --color=auto"' >> /root/.bashrc
RUN echo 'alias ls="ls --color=auto"' >> /etc/skel/.bashrc
RUN echo 'alias grep="grep --color=auto"' >> /etc/skel/.bashrc

RUN echo "bash -c 'echo -e \"\n\
ðŸ”§ Verilator version:  \$(verilator --version)\n\
ðŸš€ Spike version:      \$(spike --help 2>&1 | head -n 1)\n\
ðŸ”¨ RISC-V GCC:         \$(riscv64-unknown-elf-gcc --version | head -n 1)\n\
ðŸ Python:             \$(python3 --version)\"'" >> /root/.bashrc

CMD ["/bin/bash"]
